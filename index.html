<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MyAlgo – Excel to Output Generator</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body{font-family:Arial, sans-serif; padding:20px; max-width:1100px;}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin:10px 0;}
    label{font-size:14px;}
    select,input,button{padding:8px 10px; font-size:14px;}
    button{cursor:pointer;}
    .card{border:1px solid #ddd; border-radius:10px; padding:14px; margin-top:14px;}
    .small{color:#555; font-size:13px;}
    table{border-collapse:collapse; width:100%; margin-top:10px;}
    th,td{border:1px solid #ddd; padding:8px; text-align:left; font-size:13px;}
    th{background:#f6f6f6;}
    .warn{color:#b45309;}
    .ok{color:#166534;}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
</head>
<body>
  <h2>MyAlgo – Generate Output Sheet</h2>

  <div class="card">
    <div class="row">
      <label><b>1) Upload Excel</b> (.xlsx):</label>
      <input type="file" id="fileInput" accept=".xlsx" />
    </div>

    <div class="row">
      <label><b>2) Run on</b></label>
      <select id="sourceSelect">
        <option value="Input">Input sheet (single company)</option>
        <option value="Data sheet">Data sheet (all companies)</option>
      </select>

      <label style="margin-left:8px;"><b>3) Category</b></label>
      <select id="categorySelect">
        <option value="All">All</option>
        <option value="Excellent">Excellent</option>
        <option value="Good">Good</option>
        <option value="Average">Average</option>
        <option value="Below average">Below average</option>
      </select>

      <button id="btnRun">Process & Download</button>
    </div>

    <div class="small">
      Output format matches the workbook’s <b>Output</b> sheet structure:
      blank rows, “Output Table”, then columns: <b>Sr, Company, Investment, Amount, Trigger Price, Average Price, Close Price</b>.
    </div>

    <div id="status" class="small" style="margin-top:10px;"></div>
    <div id="preview"></div>
  </div>

<script>
(function(){
  const AMOUNT = 100000;

  // ====== CATEGORY LISTS (from your Word doc lists) ======
  // NOTE: Matching is done using a normalized form (trim + collapse spaces + strip NBSP).
  // So "HDFC Bank", "HDFC  Bank", or "HDFC Bank " will all match.
  const COMPANY_LISTS = {
    "Excellent": new Set([
      "Apar Inds.","APL Apollo Tubes","Asian Paints","AU Small Finance","Bajaj Auto",
      "Bajaj Finance","Berger Paints","Bharat Electron","Blue Jet Health","Blue Star",
      "BSE","Cams Services","CG Power & Ind","Cholaman.Inv.&Fn","Coal India",
      "Coforge","Cummins India","Doms Industries","eClerx Services","Eicher Motors",
      "Esab India","Gabriel India","Garden Reach Sh.","Havells India","HDFC AMC",
      "HDFC Bank","Hero MotoCorp","Hind.Aeronautics","Hyundai Motor I","I R C T C",
      "ICICI Bank","Indrapr.Medical","Infosys","Ingersoll-Rand","ITC","K P R Mill Ltd",
      "Kotak Mah. Bank","KPIT Technologi.","Lloyds Metals","LTI Mindtree",
      "Motherson Wiring","Muthoot Finance","Nestle India","NMDC","Page Industries",
      "Persistent Syste","Polycab India","Praj Industries","R Systems Intl.",
      "Redington","Safari Inds.","SBI Cards","Sharda Motor","Solar Industries",
      "Sonata Software","Sun Pharma.Inds.","Supreme Inds.","Supreme Petroch.",
      "TCS","Tips Music","Titan Company","Triveni Turbine","Tube Investments",
      "Varun Beverages","Volt.Transform.","Waaree Energies","Zydus Lifesci."
    ]),
    "Good": new Set([
      "360 ONE","3M India","Aadhar Hsg. Fin.","Aavas Financiers","Abbott India",
      "Acutaas Chemical","Adani Power","Adani Total Gas","Aditya AMC",
      "Aditya Birla Cap","Aditya Vision","Ador Welding","Aegis Logistics","Affle 3i",
      "Ahluwalia Contr.","AIA Engineering","Ajanta Pharma","Akzo Nobel",
      "Alivus Life","Alkem Lab","Alkyl Amines","Amara Raja Ener.","Amber Enterp.",
      "Amrutanjan Healt","Anand Rathi Wea.","Angel One","Apollo Hospitals",
      "Apollo Tyres","Aptus Value Hou.","Archean Chemical","Ashoka Buildcon",
      "ASK Automotive","Astra Microwave","Astral","Astrazeneca Phar",
      "Aurobindo Pharma","Automotive Axles","Avanti Feeds","Avenue Super.",
      "Axis Bank","B P C L","Bajaj Consumer","Bajaj Finserv","Bajaj Holdings",
      "Balkrishna Inds","Bandhan Bank","Bank Of Baroda","Bank Of India",
      "Bank of Maha","BASF India","Bata India","Bayer CropSci.","BEML Ltd",
      "Bharat Bijlee","Bharat Dynamics","Bharat Forge","Bharti Airtel",
      "Bharti Hexacom","Bikaji Foods","Birlasoft Ltd","Blue Dart Expres",
      "Bosch","Britannia Inds.","C D S L","C P C L","C.E. Info System",
      "Can Fin Homes","Canara Bank","Capacit'e Infra.","Caplin Point Lab",
      "Carborundum Uni.","CARE Ratings","Carysil","Castrol India","CEAT",
      "Cello World","Century Plyboard","Cera Sanitary.","Chambal Fert.",
      "CIE Automotive","Cigniti Tech.","Cipla","City Union Bank","Clean Science",
      "CMS Info Systems","Cochin Shipyard","Cohance Life","Colgate-Palmoliv",
      "Concord Biotech","Coromandel Inter","Craftsman Auto",
      "CreditAcc. Gram.","CRISIL","Crompton Gr. Con","Cyient",
      "Dabur India","Data Pattern","DCB Bank","DCM Shriram",
      "Deepak Fertilis.","Deepak Nitrite","Delta Corp","Dhanuka Agritech",
      "Diffusion Eng","Disa India","Divi's Lab.","Dixon Technolog.",
      "Dr Lal Pathlabs","Dr Reddy's Labs"
      // If you have the remaining "Good" names, paste them here too.
    ]),
    "Average": new Set([
      "A B Real Estate","Aarti Drugs","Aarti Industries","Aarti Pharma","ACC",
      "Action Const.Eq.","Adani Enterp.","Adani Ports","ADF Foods",
      "Advanced Enzyme","Aether Industri.","Afcons Infrastr.",
      "Akums Drugs","Alembic Pharma","Alicon Cast.","Allcargo Logist.",
      "Altius Telecom","Ambuja Cements","Anant Raj","Antelopus Selan",
      "Anupam Rasayan","Apeejay Surrend.","Apollo Pipes","Arrow Greentech"
      // If you have the remaining "Average" names, paste them here too.
    ]),
    "Below average": new Set([
      "Adani Energy Sol","Adani Green","Aditya Bir. Fas.","Alok Industries",
      "Asian Granito","Aster DM Health.","Atul Auto","Bajaj Hindusthan",
      "Borosil Renew.","Chola Financial","Cube Highways","Delhivery",
      "GMR Airports","Godrej Industrie","Godrej Propert.","IFCI",
      "India Cements","IRB Infra.Devl.","ITI","Mahindra Life",
      "Medplus Health","Meghmani Organi.","Muthoot Cap.Serv",
      "Netwrk.18 Media","NLC India","NMDC Steel","Nuvoco Vistas",
      "Ola Electric","PC Jeweller","Prestige Estates","Prime Securities",
      "Prism Johnson","PTC Industries","Raymond Lifestyl",
      "Reliance Infra.","Reliance Power","Restaurant Brand",
      "Sh.Renuka Sugar","Sobha","SPARC","Sterling & Wils.",
      "Sterlite Tech.","Stove Kraft","Swan Corp","Swiggy",
      "Tata Tele. Mah.","Tejas Networks","The Ramco Cement",
      "TVS Supply","Valor Estate","Vodafone Idea","Wockhardt"
    ])
  };

  function normCompany(s){
    if (s == null) return "";
    return String(s)
      .replace(/\u00A0/g, " ")      // NBSP -> space
      .replace(/\s+/g, " ")        // collapse spaces
      .trim();
  }

  function buildNormalizedSet(set){
    const out = new Set();
    for (const x of set) out.add(normCompany(x));
    return out;
  }

  const COMPANY_LISTS_N = {
    "Excellent": buildNormalizedSet(COMPANY_LISTS["Excellent"]),
    "Good": buildNormalizedSet(COMPANY_LISTS["Good"]),
    "Average": buildNormalizedSet(COMPANY_LISTS["Average"]),
    "Below average": buildNormalizedSet(COMPANY_LISTS["Below average"])
  };

  function setStatus(msg, kind=""){
    const el = document.getElementById('status');
    if (kind === "warn") el.innerHTML = `<span class="warn">${msg}</span>`;
    else if (kind === "ok") el.innerHTML = `<span class="ok">${msg}</span>`;
    else el.innerHTML = msg;
  }

  function readSheetRows(wb, sheetName){
    const sheet = wb.Sheets[sheetName];
    if (!sheet) return null;
    return XLSX.utils.sheet_to_json(sheet, { header: 1, raw: true, defval: null });
  }

  function findSelIndicesForSheet(rows){
    // Column G = index 6 has "Sel"
    const sel = [];
    for (let i=0;i<rows.length;i++){
      if (rows[i] && rows[i][6] === "Sel") sel.push(i);
    }
    return sel;
  }

  function computeForSel(initialPrice){
    // Trigger prices at -10%, -20%, -30% of initial, rounded down to integer.
    const t1 = Math.floor(initialPrice * 0.90);
    const t2 = Math.floor(initialPrice * 0.80);
    const t3 = Math.floor(initialPrice * 0.70);
    const avg = Math.round((t1 + t2 + t3) / 3);
    const close = Math.floor(avg * 1.30);
    return { t1, t2, t3, avg, close };
  }

  function generateOutputRows(results){
    const out = [];
    for (let i=0;i<6;i++) out.push([null,null,null,null,null,null,null]);
    out.push(["Output Table", null, null, null, null, null, null]);
    out.push([null,null,null,null,null,null,null]);
    out.push(["Sr","Company","Investment","Amount","Trigger Price","Average Price","Close Price"]);
    out.push([null,null,null,null,null,null,"30% above average price"]);

    let sr = 1;
    for (const r of results){
      out.push([sr++, r.company, "Invest 1", AMOUNT, r.t1, r.avg, r.close]);
      out.push([sr++, r.company, "Invest 2", AMOUNT, r.t2, null, null]);
      out.push([sr++, r.company, "Invest 3", AMOUNT, r.t3, null, null]);
    }
    return out;
  }

  function renderPreview(outputAOA, maxRows=20){
    const start = 8;
    const slice = outputAOA.slice(start, Math.min(outputAOA.length, start+maxRows));
    if (!slice.length) { document.getElementById("preview").innerHTML=""; return; }
    let html = `<table><thead><tr>` +
      slice[0].map(x=>`<th>${x===null?"":String(x)}</th>`).join("") +
      `</tr></thead><tbody>`;
    for (let i=1;i<slice.length;i++){
      html += `<tr>` + slice[i].map(x=>`<td>${x===null?"":String(x)}</td>`).join("") + `</tr>`;
    }
    html += `</tbody></table>`;
    document.getElementById("preview").innerHTML = html;
  }

  function buildCompanyFilter(category){
    if (category === "All") return null;
    return COMPANY_LISTS_N[category] || new Set();
  }

  async function process(){
    const file = document.getElementById("fileInput").files[0];
    if (!file){ alert("Select an Excel file first."); return; }

    setStatus("Reading file...");
    const buf = await file.arrayBuffer();
    const wb = XLSX.read(buf, { type: "array", cellDates: true, raw: true });

    const sourceSheet = document.getElementById("sourceSelect").value;
    const category = document.getElementById("categorySelect").value;

    const rows = readSheetRows(wb, sourceSheet);
    if (!rows){ alert(`Sheet not found: ${sourceSheet}`); return; }

    const filterSet = buildCompanyFilter(category);

    const results = [];
    const sels = findSelIndicesForSheet(rows);

    if (!sels.length){
      alert(`"Sel" not found in sheet: ${sourceSheet}`);
      return;
    }

    for (const idx of sels){
      const r = rows[idx];
      const companyRaw = r[3];
      const company = normCompany(companyRaw);
      const initial = r[4];
      if (!company) continue;
      if (typeof initial !== "number") continue;

      if (filterSet && !filterSet.has(company)){
        continue;
      }

      const calc = computeForSel(initial);
      results.push({ company, ...calc });
    }

    if (!results.length){
      // Show debug hint: what company names were seen in the sheet for Sel rows
      const seen = sels.slice(0, 10).map(i => normCompany(rows[i][3])).filter(Boolean);
      setStatus(
        `No matching rows generated for category "${category}". ` +
        `First Sel companies seen: <span class="mono">${seen.join(" | ") || "(none)"}</span>`,
        "warn"
      );
      document.getElementById("preview").innerHTML = "";
      return;
    }

    const outputAOA = generateOutputRows(results);

    const outWb = XLSX.utils.book_new();
    const outSheet = XLSX.utils.aoa_to_sheet(outputAOA);
    XLSX.utils.book_append_sheet(outWb, outSheet, "Output");

    renderPreview(outputAOA);

    const suffix = sourceSheet === "Input" ? "Single" : "All";
    const fname = `MyAlgo_Output_${suffix}_${category.replace(/\s+/g,'_')}.xlsx`;
    XLSX.writeFile(outWb, fname);

    setStatus(`Done. Generated ${results.length} signal(s) → ${results.length*3} output rows. Download started.`, "ok");
  }

  document.getElementById("btnRun").addEventListener("click", process);
})();
</script>
</body>
</html>
